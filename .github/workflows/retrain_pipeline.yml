name: Automated Model Retraining Pipeline

on:
  push:
    paths:
      - 'data/**'
  workflow_dispatch:

jobs:
  retrain-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ðŸ Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ“ Create Directories
        run: |
          mkdir -p models
          mkdir -p data/new_data
          mkdir -p mlruns
      
      - name: ðŸ”„ Merge New Data
        run: |
          cat > merge_data.py << 'EOF'
          import pandas as pd
          import glob
          
          training_data = pd.read_csv('data/training_data.csv')
          print(f"Current training data: {training_data.shape[0]} rows")
          
          new_data_files = glob.glob('data/new_data/*.csv')
          
          if new_data_files:
              print(f"Found {len(new_data_files)} new data files")
              new_data_list = [pd.read_csv(f) for f in new_data_files]
              all_new_data = pd.concat(new_data_list, ignore_index=True)
              updated_data = pd.concat([training_data, all_new_data], ignore_index=True)
              updated_data = updated_data.drop_duplicates()
              updated_data.to_csv('data/training_data.csv', index=False)
              print(f"Updated training data: {updated_data.shape[0]} rows")
          else:
              print("No new data files found")
          EOF
          
          python merge_data.py
      
      - name: ðŸŽ¯ Train New Model
        id: train
        run: |
          echo "Starting model training..."
          python src/train.py
          R2_SCORE=$(python -c "import json; print(json.load(open('models/model_metadata.json'))['metrics']['r2_score'])")
          echo "r2_score=$R2_SCORE" >> $GITHUB_OUTPUT
          echo "New Model RÂ² Score: $R2_SCORE"
      
      - name: ðŸ” Compare Models
        id: compare
        continue-on-error: true
        run: |
          python src/compare.py ${{ steps.train.outputs.r2_score }}
          echo "should_deploy=true" >> $GITHUB_OUTPUT
      
      - name: ðŸ” Check Comparison Failed
        if: failure()
        run: |
          echo "should_deploy=false" >> $GITHUB_OUTPUT
      
      - name: ðŸš€ Deploy New Model
        if: steps.compare.outcome == 'success'
        run: |
          echo "Deploying new model..."
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git add models/current_model.pkl models/model_metadata.json data/training_data.csv
          git commit -m "Auto-deploy: New model RÂ²=${{ steps.train.outputs.r2_score }}"
          git push
          echo "Model deployed successfully!"
      
      - name: ðŸ›‘ Keep Current Model
        if: steps.compare.outcome == 'failure'
        run: |
          echo "New model did not meet improvement threshold"
          echo "Keeping current production model"
      
      - name: ðŸ“Š Generate Summary
        if: always()
        run: |
          echo "# Model Retraining Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "New Model R2 Score: ${{ steps.train.outputs.r2_score }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Automated by GitHub Actions" >> $GITHUB_STEP_SUMMARY